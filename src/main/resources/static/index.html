<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Claude Code Hooks - Observability dashboard for Claude Code permission requests and task completions">
    <meta name="theme-color" content="#667eea">
    <title>Claude Code Hooks Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMTMuMDkgOC4yNkwyMCA5TDEzLjA5IDE1Ljc0TDEyIDIyTDEwLjkxIDE1Ljc0TDQgOUwxMC45MSA4LjI2TDEyIDJaIiBmaWxsPSIjNjY3ZWVhIi8+Cjwvc3ZnPgo=">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header__content">
                <div class="header__left">
                    <div class="theme-selector">
                        <button 
                            class="theme-selector__btn" 
                            data-theme="light" 
                            title="Light theme"
                            aria-label="Switch to light theme">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <circle cx="12" cy="12" r="5"/>
                                <line x1="12" y1="1" x2="12" y2="3"/>
                                <line x1="12" y1="21" x2="12" y2="23"/>
                                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                                <line x1="1" y1="12" x2="3" y2="12"/>
                                <line x1="21" y1="12" x2="23" y2="12"/>
                                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                            </svg>
                        </button>
                        <button 
                            class="theme-selector__btn" 
                            data-theme="dark" 
                            title="Dark theme"
                            aria-label="Switch to dark theme">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                            </svg>
                        </button>
                        <button 
                            class="theme-selector__btn" 
                            data-theme="system" 
                            title="System theme"
                            aria-label="Use system theme">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                                <line x1="8" y1="21" x2="16" y2="21"/>
                                <line x1="12" y1="17" x2="12" y2="21"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="header__title">
                    <h1>Claude Code Hooks</h1>
                    <p>Observability Dashboard</p>
                </div>
                
                <div class="header__right">
                    <div class="status-indicators" role="region" aria-label="System status">
                        <div 
                            class="status-indicator status-indicator--connection" 
                            id="connectionStatus" 
                            role="status"
                            aria-live="polite"
                            aria-label="Service connection status">
                        </div>
                        <div 
                            class="status-indicator status-indicator--notifications" 
                            id="notificationStatus" 
                            role="status"
                            aria-live="polite"
                            aria-label="Browser notifications status">
                        </div>
                    </div>
                    
                    <button 
                        class="header__btn header__btn--help" 
                        id="helpBtn"
                        title="Help"
                        aria-label="Show help information"
                        aria-expanded="false"
                        aria-controls="helpTooltip">
                        ?
                    </button>
                    
                    <button 
                        class="header__btn header__btn--menu" 
                        id="menuBtn"
                        title="Menu"
                        aria-label="Open menu"
                        aria-expanded="false"
                        aria-controls="dropdownMenu">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <line x1="3" y1="6" x2="21" y2="6"/>
                            <line x1="3" y1="12" x2="21" y2="12"/>
                            <line x1="3" y1="18" x2="21" y2="18"/>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Help Tooltip -->
        <div class="tooltip" id="helpTooltip" role="tooltip" aria-hidden="true">
            <h3 class="tooltip__title">Status Indicators</h3>
            <ul class="tooltip__list">
                <li class="tooltip__item">
                    <div class="status-indicator status-indicator--connection status-indicator--connected"></div>
                    <span>Service Connected</span>
                </li>
                <li class="tooltip__item">
                    <div class="status-indicator status-indicator--connection"></div>
                    <span>Service Disconnected</span>
                </li>
                <li class="tooltip__item">
                    <div class="status-indicator status-indicator--notifications status-indicator--enabled"></div>
                    <span>Browser Notifications Enabled</span>
                </li>
                <li class="tooltip__item">
                    <div class="status-indicator status-indicator--notifications"></div>
                    <span>Browser Notifications Disabled</span>
                </li>
            </ul>
        </div>


        <!-- Dropdown Menu -->
        <div class="dropdown-menu" id="dropdownMenu" role="menu" aria-hidden="true">
            <div class="dropdown-menu__section">
                <h3 class="dropdown-menu__header">System Statistics</h3>
                <div class="dropdown-menu__item" role="menuitem" tabindex="-1">
                    <span class="dropdown-menu__label">Active Streams</span>
                    <span class="dropdown-menu__value" id="activeStreamsCount">0</span>
                </div>
                <div class="dropdown-menu__item" role="menuitem" tabindex="-1">
                    <span class="dropdown-menu__label">Uptime</span>
                    <span class="dropdown-menu__value" id="uptimeDisplay">00:00:00</span>
                </div>
            </div>
            
            <div class="dropdown-menu__separator" role="separator"></div>
            
            <div class="dropdown-menu__section">
                <button class="dropdown-menu__item dropdown-menu__item--clickable" role="menuitem" data-action="test-notification">
                    <span class="dropdown-menu__label">Test Notification</span>
                    <span class="dropdown-menu__shortcut">⌘T</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main">
            <section class="notifications" aria-labelledby="notificationsTitle">
                <header class="notifications__header">
                    <h2 id="notificationsTitle">Recent Notifications (0 total)</h2>
                    <div class="notifications__actions">
                        <button 
                            class="notifications__btn notifications__btn--delete-all" 
                            id="deleteAllBtn"
                            title="Delete all notifications"
                            aria-label="Delete all notifications">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <polyline points="3,6 5,6 21,6"/>
                                <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
                                <line x1="10" y1="11" x2="10" y2="17"/>
                                <line x1="14" y1="11" x2="14" y2="17"/>
                            </svg>
                        </button>
                    </div>
                </header>
                
                <div class="notifications__table" role="table" aria-label="Notifications table">
                    <div class="notifications__table-header" role="row">
                        <div class="notifications__table-cell" role="columnheader">Time</div>
                        <div class="notifications__table-cell" role="columnheader">Message</div>
                        <div class="notifications__table-cell" role="columnheader">Date</div>
                        <div class="notifications__table-cell" role="columnheader">Actions</div>
                    </div>
                    
                    <div id="notificationsList" class="notifications__list" role="rowgroup">
                        <div class="notifications__empty" role="status">
                            <div class="notifications__empty-icon" aria-hidden="true">·</div>
                            <p>No notifications yet</p>
                            <p class="notifications__empty-subtitle">Test the connection or wait for Claude to request permissions</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Scripts -->
    <script type="module" src="js/main.js"></script>
    
    <!-- Fallback for basic functionality -->
    <script>
        // Simple fallback implementation for basic interactions
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Setting up basic functionality fallback');
            
            // Theme switching
            document.querySelectorAll('.theme-selector__btn').forEach(button => {
                button.addEventListener('click', function() {
                    const theme = this.getAttribute('data-theme');
                    console.log('Theme button clicked:', theme);
                    
                    // Apply theme to document
                    document.documentElement.setAttribute('data-theme', theme);
                    
                    // Update active button
                    document.querySelectorAll('.theme-selector__btn').forEach(btn => {
                        btn.classList.remove('theme-selector__btn--active');
                        btn.setAttribute('aria-pressed', 'false');
                    });
                    this.classList.add('theme-selector__btn--active');
                    this.setAttribute('aria-pressed', 'true');
                    
                    // Save to localStorage
                    try {
                        localStorage.setItem('claude-hooks-theme', theme);
                    } catch (e) {
                        console.warn('Could not save theme to localStorage:', e);
                    }
                });
            });
            
            // Help button
            const helpBtn = document.getElementById('helpBtn');
            const helpTooltip = document.getElementById('helpTooltip');
            if (helpBtn && helpTooltip) {
                helpBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const isVisible = helpTooltip.getAttribute('aria-hidden') === 'false';
                    helpTooltip.setAttribute('aria-hidden', isVisible ? 'true' : 'false');
                    helpBtn.setAttribute('aria-expanded', isVisible ? 'false' : 'true');
                    
                    // Position tooltip
                    if (!isVisible) {
                        const rect = helpBtn.getBoundingClientRect();
                        helpTooltip.style.left = (rect.left - 200) + 'px';
                        helpTooltip.style.top = (rect.bottom + 10) + 'px';
                    }
                });
            }
            
            // Menu button
            const menuBtn = document.getElementById('menuBtn');
            const dropdownMenu = document.getElementById('dropdownMenu');
            if (menuBtn && dropdownMenu) {
                menuBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const isVisible = dropdownMenu.getAttribute('aria-hidden') === 'false';
                    dropdownMenu.setAttribute('aria-hidden', isVisible ? 'true' : 'false');
                    menuBtn.setAttribute('aria-expanded', isVisible ? 'false' : 'true');
                    menuBtn.classList.toggle('header__btn--active', !isVisible);
                    
                    // Position menu
                    if (!isVisible) {
                        const rect = menuBtn.getBoundingClientRect();
                        dropdownMenu.style.left = (rect.left - 180) + 'px';
                        dropdownMenu.style.top = (rect.bottom + 10) + 'px';
                    }
                });
            }
            
            // Delete all button
            const deleteAllBtn = document.getElementById('deleteAllBtn');
            if (deleteAllBtn) {
                deleteAllBtn.addEventListener('click', function() {
                    if (confirm('Delete all notifications?')) {
                        notificationsData = [];
                        renderNotificationsList();
                        updateNotificationsTitle();
                    }
                });
            }
            
            // Menu actions
            document.querySelectorAll('[data-action]').forEach(button => {
                button.addEventListener('click', function() {
                    const action = this.getAttribute('data-action');
                    console.log('Menu action clicked:', action);
                    
                    switch (action) {
                        case 'test-notification':
                            if ('Notification' in window) {
                                if (Notification.permission === 'granted') {
                                    new Notification('🧪 Test Notification', {
                                        body: 'This is a test notification from Claude Code Hooks!',
                                        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMTMuMDkgOC4yNkwyMCA5TDEzLjA5IDE1Ljc0TDEyIDIyTDEwLjkxIDE1Ljc0TDQgOUwxMC45MSA4LjI2TDEyIDJaIiBmaWxsPSIjNjY3ZWVhIi8+Cjwvc3ZnPgo='
                                    });
                                } else {
                                    Notification.requestPermission().then(permission => {
                                        updateNotificationStatus(); // Update status after permission change
                                        if (permission === 'granted') {
                                            new Notification('🧪 Test Notification', {
                                                body: 'This is a test notification from Claude Code Hooks!'
                                            });
                                        }
                                    });
                                }
                            } else {
                                alert('Browser notifications are not supported');
                            }
                            break;
                            
                        case 'clear-notifications':
                            if (confirm('Clear all notifications?')) {
                                const notificationsList = document.getElementById('notificationsList');
                                if (notificationsList) {
                                    notificationsList.innerHTML = `
                                        <div class="notifications__empty" role="status">
                                            <div class="notifications__empty-icon" aria-hidden="true">·</div>
                                            <p>No notifications yet</p>
                                            <p class="notifications__empty-subtitle">Test the connection or wait for Claude to request permissions</p>
                                        </div>
                                    `;
                                }
                            }
                            break;
                            
                    }
                });
            });
            
            // Click outside to close menus
            document.addEventListener('click', function() {
                if (helpTooltip) helpTooltip.setAttribute('aria-hidden', 'true');
                if (helpBtn) helpBtn.setAttribute('aria-expanded', 'false');
                if (dropdownMenu) dropdownMenu.setAttribute('aria-hidden', 'true');
                if (menuBtn) {
                    menuBtn.setAttribute('aria-expanded', 'false');
                    menuBtn.classList.remove('header__btn--active');
                }
            });
            
            // ESC key to close menus
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    if (helpTooltip) helpTooltip.setAttribute('aria-hidden', 'true');
                    if (helpBtn) helpBtn.setAttribute('aria-expanded', 'false');
                    if (dropdownMenu) dropdownMenu.setAttribute('aria-hidden', 'true');
                    if (menuBtn) {
                        menuBtn.setAttribute('aria-expanded', 'false');
                        menuBtn.classList.remove('header__btn--active');
                    }
                }
            });
            
            // Load saved theme
            try {
                const savedTheme = localStorage.getItem('claude-hooks-theme') || 'system';
                const themeButton = document.querySelector(`[data-theme="${savedTheme}"]`);
                if (themeButton) {
                    themeButton.click();
                }
            } catch (e) {
                console.warn('Could not load saved theme:', e);
                // Default to system theme
                const systemButton = document.querySelector('[data-theme="system"]');
                if (systemButton) systemButton.click();
            }
            
            console.log('Basic functionality fallback setup complete');
            
            // Update notification status
            updateNotificationStatus();
            
            // Initialize audio on first user interaction
            document.addEventListener('click', function() {
                initializeAudio();
            }, { once: true });
            
            // Set up SSE connection
            setupSSEConnection();
            
        });
        
        // Audio Management
        let audioContext = null;
        let isAudioInitialized = false;
        
        function initializeAudio() {
            if (isAudioInitialized || !('AudioContext' in window || 'webkitAudioContext' in window)) {
                return;
            }
            
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Resume audio context if it's suspended (required for Chrome)
                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        console.log('Audio context resumed');
                        isAudioInitialized = true;
                    }).catch(error => {
                        console.warn('Failed to resume audio context:', error);
                    });
                } else {
                    isAudioInitialized = true;
                    console.log('Audio context initialized');
                }
            } catch (error) {
                console.warn('Failed to initialize audio context:', error);
            }
        }
        
        function playNotificationSound() {
            if (!audioContext) {
                return;
            }
            
            // Resume audio context if needed
            if (audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    playNotificationSoundInternal();
                }).catch(error => {
                    console.warn('Failed to resume audio context for notification:', error);
                });
            } else if (audioContext.state === 'running') {
                playNotificationSoundInternal();
            }
        }
        
        function playNotificationSoundInternal() {
            try {
                // Create a simple notification sound (glass sound)
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Glass sound: C7 note (2093 Hz)
                oscillator.frequency.setValueAtTime(2093, audioContext.currentTime);
                oscillator.type = 'sine';
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 1.2);
                
                console.log('🔊 Notification sound played');
            } catch (error) {
                console.warn('Failed to play notification sound:', error);
            }
        }
        
        // SSE Connection Management
        let eventSource = null;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 10;
        
        function setupSSEConnection() {
            console.log('Setting up SSE connection...');
            
            if (eventSource) {
                eventSource.close();
            }
            
            try {
                eventSource = new EventSource('/api/v1/claude-code/hooks/events/stream');
                
                eventSource.onopen = function(event) {
                    console.log('✅ SSE connection established');
                    reconnectAttempts = 0;
                    updateConnectionStatus(true);
                };
                
                eventSource.onmessage = function(event) {
                    console.log('📨 SSE message received:', event.data);
                };
                
                eventSource.addEventListener('claude-hook', function(event) {
                    console.log('🎯 Claude hook event received:', event.data);
                    try {
                        const hookEvent = JSON.parse(event.data);
                        handleClaudeHookEvent(hookEvent);
                    } catch (error) {
                        console.error('Error processing claude hook event:', error);
                    }
                });
                
                eventSource.onerror = function(event) {
                    console.error('❌ SSE connection error:', event);
                    updateConnectionStatus(false);
                    
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        const delay = Math.min(1000 * Math.pow(1.5, reconnectAttempts), 30000);
                        console.log(`🔄 Reconnecting in ${delay}ms (attempt ${reconnectAttempts}/${maxReconnectAttempts})`);
                        
                        setTimeout(() => {
                            setupSSEConnection();
                        }, delay);
                    } else {
                        console.error('Max reconnect attempts reached');
                    }
                };
                
            } catch (error) {
                console.error('Failed to create SSE connection:', error);
                updateConnectionStatus(false);
            }
        }
        
        function updateConnectionStatus(connected) {
            const connectionStatus = document.getElementById('connectionStatus');
            if (connectionStatus) {
                if (connected) {
                    connectionStatus.classList.add('status-indicator--connected');
                    connectionStatus.setAttribute('aria-label', 'Service connected');
                } else {
                    connectionStatus.classList.remove('status-indicator--connected');
                    connectionStatus.setAttribute('aria-label', 'Service disconnected');
                }
            }
        }
        
        function updateNotificationStatus() {
            const notificationStatus = document.getElementById('notificationStatus');
            if (notificationStatus) {
                const isEnabled = 'Notification' in window && Notification.permission === 'granted';
                notificationStatus.classList.toggle('status-indicator--enabled', isEnabled);
                notificationStatus.setAttribute('aria-label', 
                    isEnabled ? 'Browser notifications enabled' : 'Browser notifications disabled'
                );
            }
        }
        
        function handleClaudeHookEvent(hookEvent) {
            console.log('📝 Processing Claude hook event:', hookEvent);
            
            // Play notification sound
            playNotificationSound();
            
            // Show browser notification if permitted
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('🤖 Claude Code Hooks', {
                    body: hookEvent.reason || hookEvent.message || 'Claude notification',
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMTMuMDkgOC4yNkwyMCA5TDEzLjA5IDE1Ljc0TDEyIDIyTDEwLjkxIDE1Ljc0TDQgOUwxMC45MSA4LjI2TDEyIDJaIiBmaWxsPSIjNjY3ZWVhIi8+Cjwvc3ZnPgo=',
                    tag: 'claude-hook-' + (hookEvent.id || Date.now())
                });
            }
            
            // Add to notifications list
            addNotificationToList(hookEvent);
            
            // Update notifications title
            updateNotificationsTitle();
        }
        
        let notificationsData = [];
        
        function addNotificationToList(hookEvent) {
            notificationsData.unshift(hookEvent);
            
            // Keep only last 100 notifications
            if (notificationsData.length > 100) {
                notificationsData = notificationsData.slice(0, 100);
            }
            
            renderNotificationsList();
        }
        
        function renderNotificationsList() {
            const notificationsList = document.getElementById('notificationsList');
            if (!notificationsList) return;
            
            if (notificationsData.length === 0) {
                notificationsList.innerHTML = `
                    <div class="notifications__empty" role="status">
                        <div class="notifications__empty-icon" aria-hidden="true">·</div>
                        <p>No notifications yet</p>
                        <p class="notifications__empty-subtitle">Test the connection or wait for Claude to request permissions</p>
                    </div>
                `;
                return;
            }
            
            const notificationsHTML = notificationsData.map((notification, index) => {
                const timestamp = new Date(notification.timestamp || notification.metadata?.timestamp || Date.now());
                const timeStr = timestamp.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                const dateStr = timestamp.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
                
                // Create project path display from event data
                const projectPath = notification.context_work_directory || notification.project_context || notification.projectContext;
                const projectPathContent = projectPath 
                    ? `<div class="notifications__project-path notifications__project-path--loaded">${projectPath}</div>`
                    : '';
                    
                // Use reason consistently (fallback to message for backwards compatibility)
                const message = notification.reason || notification.message || 'No message';
                
                return `
                    <div class="notifications__row" role="row">
                        <div class="notifications__cell notifications__cell--time" role="cell">${timeStr}</div>
                        <div class="notifications__cell notifications__cell--message" role="cell">
                            <div class="notifications__reason">${message}</div>
                            ${projectPathContent}
                        </div>
                        <div class="notifications__cell notifications__cell--date" role="cell">${dateStr}</div>
                        <div class="notifications__cell notifications__cell--actions" role="cell">
                            <button 
                                class="notifications__delete-btn" 
                                onclick="removeNotification(${index})"
                                aria-label="Delete notification"
                                title="Delete notification">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <line x1="18" y1="6" x2="6" y2="18"/>
                                    <line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            notificationsList.innerHTML = notificationsHTML;
            
        }
        
        
        function removeNotification(index) {
            notificationsData.splice(index, 1);
            renderNotificationsList();
            updateNotificationsTitle();
        }
        
        function updateNotificationsTitle() {
            const notificationsTitle = document.getElementById('notificationsTitle');
            if (notificationsTitle) {
                notificationsTitle.textContent = `Recent Notifications (${notificationsData.length} total)`;
            }
        }
        

        // Make functions globally accessible
        window.removeNotification = removeNotification;
    </script>
</body>
</html>